<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bettr Casino: Open Source Game Development Platform</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>
    <script src="https://cmp.osano.com/Azyq2mU0Sb8gd7G6E/a5c3c18a-3383-4f4f-9ec7-2ecb3f239c09/osano.js"></script>
    <style>

        .header-buttons {
            text-align: right;
            padding: 10px;
            background-color: #002246; /* Optional: to match the header color */
        }

        .header-btn {
            color: white;
            background-color: #9a9af7;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }

        .header-btn:hover {
            background-color: #8484f8; /* Slightly lighter color on hover */
        }


        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            background-color: #fff; /* Set background color if needed */
            color: #333; /* Set text color if needed */
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        th {
            background-color: #002246; /* Updated header background color */
            color: #fff; /* Set header text color to white for better contrast */
        }

        h1 {
            background-color: #002246; /* Updated to match the provided styling */
            color: #fff; /* Set text color to white for better contrast */
            padding: 10px; /* Adjust padding as needed */
            text-align: center; /* Center the title if needed */
        }

        /* Additional styling for DataTables elements as needed */
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            background-color: #002246; /* Match button color to the theme */
            color: #fff;
            border: 1px solid #fff; /* Add white border for visibility */
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background-color: #002246; /* Maintain the same color on hover */
            border: 1px solid #aaa; /* Change border color on hover for differentiation */
        }

        .highlighted td {
            background-color: #9a9af7 !important; /* Adjust the color as needed */
        }

        #details-form {
            border: 1px solid #ddd; /* Border for the form box */
            padding: 15px; /* Padding inside the form */
            margin-top: 20px; /* Space above the form */
            background-color: #f9f9f9; /* Light background for the form */
            border-radius: 5px; /* Rounded corners for the form */
        }

        #details-form h3 {
            margin-top: 0; /* Align header to the top of the form */
            color: #002246; /* Color of the header */
        }

        #details-form p {
            font-size: 16px; /* Font size for form content */
            line-height: 1.5; /* Line height for better readability */
        }

        .details-table {
            width: 100%; /* Full width of the container */
            border-collapse: collapse; /* Collapsed borders */
        }

        .details-table td {
            padding: 5px; /* Padding in table cells */
            border: 1px solid #ddd; /* Border for each cell */
        }

        .details-table td:first-child {
            font-weight: bold; /* Bold font for keys */
            width: 30%; /* Fixed width for keys column */
        }

        .details-table td:last-child {
            width: 70%; /* Remaining width for values column */
        }

        .launch-challenge-btn {
            background-color: #9a9af7; /* Same as highlighted row color */
            color: white; /* Text color */
            padding: 10px 20px; /* Padding for size */
            border: none; /* No border */
            border-radius: 5px; /* Rounded corners */
            font-size: 16px; /* Font size */
            cursor: pointer; /* Pointer cursor on hover */
            display: block; /* Block level element */
            margin: 20px auto; /* Center align */
            text-align: center; /* Center text */

            align-items: center;
            justify-content: center;
            position: relative;
        }

        .challenge-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid #0732f3;
            width: 8px;
            height: 8px;
            margin-left: 20px;
            animation: spin 2s linear infinite;
            display: inline-block;
            position: relative;
            right: 10px;
        }

        .tag {
            display: inline-block;
            background-color: #002246;
            color: white;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 5px;
            font-size: 14px;
        }


        /* modal */
        .modal {
            position: fixed; /* Keep it fixed relative to the viewport */
            z-index: 2; /* Higher z-index to ensure it's above other content */
            display: none; /* Initially hidden */
            background-color: rgba(0, 34, 70, 0.4); /* Semi-transparent background */
        }

        .modal-content {
            background-color: #f9f9f9;
            padding: 10px;
            border: 1px solid #002246;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            width: auto; /* Auto width based on content */
            min-width: 200px; /* Minimum width */
            max-width: 300px; /* Maximum width */
        }

        .close-btn {
            color: #002246; /* Close button color to match scheme */
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover {
            color: #9a9af7; /* Color on hover */
        }

        .modal p {
            color: #333; /* Text color */
            font-size: 18px; /* Text size */
            text-align: center; /* Center the text */
        }

        .register-modal-content,
        .login-modal-content,
        .verification-modal-content {
            background-color: #f9f9f9;
            padding: 10px;
            border: 1px solid #002246;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            width: auto; /* Auto width based on content */
            min-width: 200px; /* Minimum width */
            max-width: 300px; /* Maximum width */
        }

        /* The Submit Button */
        #register_button,
        #login_button,
        #verification_button {
            background-color: #9a9af7; /* Same as highlighted row color */
            color: white; /* Text color */
            padding: 14px 20px;
            margin: 8px 0;
            border: none;
            cursor: pointer;
            width: 100%; /* Full width */
            border-radius: 5px; /* Rounded corners */
        }

        #register_button:hover,
        #login_button:hover {
            background-color: #8484f8; /* Slightly lighter color on hover */
            opacity: 0.9;
        }

        /* The Close Button */
        #register_close,
        #login_close,
        #verification_close {
            color: #002246; /* Color to match the header */
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        #register_close:hover,
        #register_close:focus,
        #login_close:hover,
        #login_close:focus, 
        #verification_close:hover,
        #verification_close:focus{
            color: #9a9af7; /* Color on hover to match the button */
            text-decoration: none;
            cursor: pointer;
        }        

        /* Style for the verification code input */
        #register-modal input[type="text"],
        #login-modal input[type="text"],
        #verification-modal input[type="text"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd; /* Light grey border */
            border-radius: 5px;
            font-size: 14px;
        }

        /* Disabled state of the button */
        #register_button:disabled,
        #login_button:disabled,
        #verification_button:disabled {
            background-color: #cccccc; /* Light gray background to indicate it's disabled */
            color: #666666; /* Darker gray text */
            cursor: not-allowed; /* Cursor to indicate the button is not clickable */
            border: 1px solid #bbbbbb; /* Border color for disabled state */
        }

        /* Hover state of the disabled button to ensure there's no change */
        #register_button:disabled:hover,
        #login_button:disabled:hover,
        #verification_button:disabled:hover {
            background-color: #cccccc; /* Same as the normal disabled state */
            opacity: 1; /* No change in opacity */
        }
                
        /* Add the back button styles as well */
        .verification-modal-back-btn {
            display: inline-block;
            margin-top: 10px;
            color: #9a9af7;
            cursor: pointer;
            text-decoration: underline;
        }

        .verification-modal-back-btn:hover {
            color: #8484f8;
        }
        
        .button-with-spinner {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .button-status-container {
            display: flex;
            align-items: center;
            justify-content: start;
            margin: 20px 0;
        }

        .status-text {
            margin-left: 10px; /* Space between the button and status text */
            display: none; /* Initially hidden */
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid #0732f3;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            animation: spin 2s linear infinite;
            position: absolute;
            right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <!-- Modal Structure -->
    <div id="user-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <p id="modal-message"></p>
        </div>
    </div>

    <!-- The Register Modal -->
    <div id="register-modal" class="modal" style="display: none;">
        <!-- Modal content -->
        <div class="register-modal-content">
            <span id="register_close" class="close">&times;</span>
            <h2>Register</h2>
            <p>We’ll email you a verification code.</p>
            <form id="register-form">
                <input type="email" placeholder="Email" name="email" required>
                <label>
                    <input type="checkbox" checked="checked" name="remember"> Remember me
                </label>
                <button id="register_button" type="button" class="button-with-spinner">
                    Get verification code
                    <div id="register-spinner" class="spinner" style="display: none;"></div>
                </button>
                <!-- Error message -->
                <p id="register-error" style="display: none; color: red;"></p>
            </form>
        </div>
    </div>

    <!-- The Login Modal similar to the Register Modal -->
    <div id="login-modal" class="modal" style="display: none;">
        <!-- Modal content -->
        <div class="login-modal-content">
            <span id="login_close" class="close">&times;</span>
            <h2>Login</h2>
            <p>We’ll email you a verification code.</p>
            <form id="login-form">
                <input type="email" placeholder="Email" name="email" required>
                <label>
                <input type="checkbox" checked="checked" name="remember"> Remember me
                </label>
                <button id="login_button" type="button" class="button-with-spinner">
                    Get verification code
                    <div id="login-spinner" class="spinner" style="display: none;"></div>
                </button>
                <!-- Error message -->
                <p id="login-error" style="display: none; color: red;"></p>
            </form>
        </div>
    </div>

    <!-- The Verification Modal -->
    <div id="verification-modal" class="modal" style="display: none;">
        <!-- Modal content -->
        <div class="verification-modal-content">
            <span id="verification_close" class="close">&times;</span>
            <span id="verification_back" class="verification-modal-back-btn">Back</span>
            <h2>Verification</h2>
            <p>We emailed you a verification code.</p>
            <form id="verification-form">
                <input type="text" placeholder="Enter Verification Code" name="verification_code" required>
                <button id="verification_button" type="button" class="button-with-spinner">
                    Verify
                    <div id="verification-spinner" class="spinner" style="display: none;"></div>
                </button>
                <!-- Error message -->
                <p id="verification-error" style="display: none; color: red;"></p>
            </form>
        </div>
    </div>

    <div class="header-buttons">
        <h1>Bettr Casino: Open Source Game Development Platform</h1>
        <button id="register-btn" class="header-btn" style="display: none;">Register</button>
        <button id="login-btn" class="header-btn" style="display: none;">Login</button>
        <button id="logout-btn" class="header-btn" style="display: none;">Logout</button>
    </div>

    <div class="content">
            
        <h2>Open Source Game Development Platform</h2>
        <p>Bettr Casino is an open source game development platform... yawn... blah blah blah... Our mission is to build and deploy online games through &lt;<strong>insert corporate speak here</strong>&gt; ... snore... zzzz... Oh, excuse me! I must have nodded off. Is the room still spinning?</p>
        <p>Hey, you! Yes, you, reading this. Do you like games? Do you like open source projects? Do you like challenges? Well, do we have a treat for you!</p>
        <p>Join us by solving the most mind-bending, hair-pulling real world challenges in the gaming industry! Well, not really ... most will be easy. Just trust us bro! </p>

        <!-- Additional Content Sections Here -->

    </div>        

    <!-- Summary Table -->
    <table id="summary-table" class="display" width="100%">
        <thead>
            <!-- Headers will be dynamically populated -->
        </thead>
        <tbody>
            <!-- Rows will be dynamically populated -->
        </tbody>
    </table>

    <!-- Details Form -->
    <div id="details-form" style="display: none;">
        <!-- Dynamic form fields will be populated here -->
    </div>

    <script>
        // Create a constant for the prefix
        const prefix = 'BETTR__';

        $(document).ready(function() {

            var userId = localStorage.getItem(`${prefix}user_id`);

            if (userId)
            {
                $('#register-btn').hide();
            }
            else
            {
                $('#register-btn').show();
            }

            const dataUrl = 'https://bettr-casino-tasks.s3.us-west-2.amazonaws.com/gsheets-task-list/allopentasks.json';
    
            // Fetch and process data
            fetch(dataUrl)
                .then(response => response.json())
                .then(data => {
                    setupTables(data);
                });

            // Function to validate email using simple regex
            function isValidEmail(email) {
                var regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return regex.test(email);
            }

            // Function to enable/disable verification button based on email validity
            function toggleVerificationButton(inputSelector, buttonSelector) {
                var email = $(inputSelector).val();
                if (isValidEmail(email)) {
                    $(buttonSelector).prop('disabled', false);
                } else {
                    $(buttonSelector).prop('disabled', true);
                }
            }

            // Event listener for email input on register modal
            $("#register-modal input[name='email']").on('input', function() {
                toggleVerificationButton("#register-modal input[name='email']", "#register_button");
            });

            // Event listener for email input on login modal
            $("#login-modal input[name='email']").on('input', function() {
                toggleVerificationButton("#login-modal input[name='email']", "#login_button");
            });

            // Initialize verification buttons as disabled
            $('#register_button').prop('disabled', true);
            $('#login_button').prop('disabled', true);

            function setupTables(data) {

                // Assuming the first row contains headers
                var headers = data.headers;
                var rows = data.rows;

                // Find the index of the "Publish" column
                const publishIndex = headers.indexOf("Publish");

                // Find indices for the 'Summary', 'Details', and 'Internal' columns
                const summaryStartIndex = headers.indexOf("Section");
                const detailsStartIndex = headers.indexOf("Section", summaryStartIndex + 1);
                const internalStartIndex = headers.indexOf("Section", detailsStartIndex + 1);
    
                // Create column definitions for Summary and Internal tables
                const summaryColumns = headers.slice(summaryStartIndex + 1, detailsStartIndex)
                    .map(header => ({ title: header }));
                const detailsColumns = headers.slice(detailsStartIndex + 1, internalStartIndex)
                    .map(header => ({ title: header }));
    
                // // Initialize the Summary DataTable
                const summaryTable = $('#summary-table').DataTable({
                    data: rows.map(row => row.slice(summaryStartIndex + 1, detailsStartIndex)), // Extract Summary columns
                    columns: summaryColumns,
                    pageLength: 5,  // Default number of rows per page
                    lengthMenu: [5, 10, 20, 50]
                });

                // Event listener for row click in Summary table
                $('#summary-table tbody').on('click', 'tr', function() {

                    // Remove highlighting from all rows
                    $('#summary-table tbody tr').removeClass('highlighted');
                
                    // Highlight the clicked row
                    $(this).addClass('highlighted');

                    const table = $('#summary-table').DataTable();
                    const rowIndex = table.row(this).index(); // Gets the index of the clicked row
                    const detailsRowData = rows.map(row => row.slice(detailsStartIndex + 1, internalStartIndex)); // Extract Details columns
                    const detailsRow = detailsRowData[rowIndex];
                    populateDetailsForm(detailsColumns, detailsRow, rowIndex);
                });

                // Check if there are rows in the table
                if (summaryTable.data().any()) {
                    // Trigger click on the first row
                    $('#summary-table tbody tr:eq(0)').click();
                }    

            }
    
            function populateDetailsForm(columns, dataRow, rowIndex) {
                const detailsForm = $('#details-form');
                // Clear existing content
                detailsForm.empty();

                // Create and append the h3 header
                const header = $('<h3>').text('Challenge Details');
                detailsForm.append(header);

                // Start the table
                const detailsTable = $('<table>').addClass('details-table');

                // Iterate over columns and add rows to the table
                columns.forEach((column, index) => {
                    const columnName = column.title;  // Assuming column object has a 'title' property
                    const columnValue = dataRow[index];

                    // Check if the column is 'Tags' and process accordingly
                    if (columnName === 'Tags' || columnName === 'Skill Sets') {
                        const tags = columnValue.split(',').map(tag => tag.trim());
                        const tagsContainer = $('<td>');
                        tags.forEach(tag => {
                            $('<span>').addClass('tag').text(tag).appendTo(tagsContainer);
                        });
                        const row = $('<tr>').append($('<td>').text(columnName)).append(tagsContainer);
                        detailsTable.append(row);
                    } else {
                        const row = $('<tr>').append($('<td>').text(columnName)).append($('<td>').text(columnValue));
                        detailsTable.append(row);
                    }

                });

                // Create a container for the button and the status text
                const buttonStatusContainer = $('<div>').addClass('button-status-container');
    
                const button = $('<button>')
                    .text(calculateLaunchButtonText(dataRow, rowIndex))
                    .addClass('launch-challenge-btn')
                    .on('click', function() {
                        launchChallenge(this, columns, dataRow, rowIndex);
                    });

                const statusText = $('<p>').text('').addClass('status-text'); // Add your status text here

                buttonStatusContainer.append(button).append(statusText);

                detailsForm.append(buttonStatusContainer);
    
                // Append the table to the form
                detailsTable.appendTo(detailsForm);
                // Show the form
                detailsForm.show();
            }

            function calculateLaunchButtonText(dataRow, rowIndex) {
                return "Launch Challenge";
            }

            function checkUserSession() {
                var userId = localStorage.getItem(`${prefix}user_id`);
                var sessionToken = localStorage.getItem(`${prefix}session_token`);

                if (!userId) {
                    showModal('Please register to launch challenges.');
                    return false;
                } else if (!sessionToken) {
                    showModal('Please login to continue.');
                    return false;
                }

                return true;
            }

            function showModal(message) {
                $('#modal-message').text(message);

                var modal = $('#user-modal');
                var windowWidth = $(window).width();
                var windowHeight = $(window).height();
                var modalWidth = modal.outerWidth();
                var modalHeight = modal.outerHeight();

                // Calculating the top and left offset to center the modal
                var top = Math.max(windowHeight / 2 - modalHeight / 2, 0);
                var left = Math.max(windowWidth / 2 - modalWidth / 2, 0);

                modal.css({
                    top: top + $(window).scrollTop(),
                    left: left + $(window).scrollLeft(),
                    position: 'absolute'
                });

                modal.show();
            }

            function launchChallenge(button, columns, dataRow, rowIndex) {
                var columnIndex = columns.findIndex(column => column.title === 'ID');
                var taskId = dataRow[columnIndex];
                if (checkUserSession()) {
                    $(button).html('Configuring Challenge <div id="launch-challenge-spinner" class="challenge-spinner"></div>');
                    var userId = localStorage.getItem(`${prefix}user_id`);
                    var sessionToken = localStorage.getItem(`${prefix}session_token`);
                    initializeDeveloperAccount(userId, sessionToken, taskId);
                    // Position the modal above the 'Launch Challenge' button
                    // positionModalAboveButton(button, dataRow);        
                } else {
                    positionModalAboveButton(button, "Register or login to launch challenges.");
                }
            }

            function positionModalAboveButton(button, message) {
                var rect = button.getBoundingClientRect();
                var modal = document.getElementById('user-modal');
                var modalContent = document.querySelector('.modal-content');

                // Calculate the modal position
                var topPosition = rect.top - modalContent.offsetHeight - 10 + window.scrollY; // 10px above the button
                var leftPosition = rect.left + (rect.width / 2) - (modalContent.offsetWidth / 2) + window.scrollX; // Centered above the button

                $('#modal-message').text(message);

                // Adjust modal position and display it
                modal.style.display = 'block';
                modal.style.top = `${topPosition}px`;
                modal.style.left = `${leftPosition}px`;
            }

            function showRegisterButton(){
                $('#register-modal').show();
                // Get the button that opens the register modal
                var registerButton = document.getElementById('register-btn');
                var rect = registerButton.getBoundingClientRect();
                var modal = document.getElementById('register-modal');

                // Calculate the modal position
                var topPosition = rect.top + window.scrollY;
                var rightPosition = 20;

                // Adjust modal position and display it
                modal.style.display = 'block';
                modal.style.top = `${topPosition}px`;
                modal.style.right = `${rightPosition}px`;
            }

            function showLoginButton() {
                $('#login-modal').show();
                // Get the button that opens the login modal
                var loginButton = document.getElementById('login-btn');
                var rect = loginButton.getBoundingClientRect();
                var modal = document.getElementById('login-modal');

                // Calculate the modal position
                var topPosition = rect.top + window.scrollY;
                var rightPosition = 20;

                // Adjust modal position and display it
                modal.style.display = 'block';
                modal.style.top = `${topPosition}px`;
                modal.style.right = `${rightPosition}px`;
            }

            // Close modal when the close button is clicked
            $('.close-btn').on('click', function() {
                $('#user-modal').hide();
            });

            // Get the register modal
            var registerModal = document.getElementById('register-modal');

            // Get the button that opens the register modal
            var registerButton = document.getElementById('register-btn');

            // Get the <span> element that closes the register modal
            var registerClose = document.getElementById('register_close');

            // When the user clicks the button, open the register modal 
            registerButton.onclick = function() {
                showRegisterButton();                
            }

            // When the user clicks on <span> (x), close the register modal
            registerClose.onclick = function() {
                registerModal.style.display = 'none';
            }

            // Get the login modal
            var loginModal = document.getElementById('login-modal');

            // Get the button that opens the login modal
            var loginButton = document.getElementById('login-btn');

            // Get the <span> element that closes the login modal
            var loginClose = document.getElementById('login_close');

            // When the user clicks the button, open the register modal 
            loginButton.onclick = function() {
                showLoginButton();                
            }

            // When the user clicks on <span> (x), close the register modal
            loginClose.onclick = function() {
                loginModal.style.display = 'none';
            }

            // When the user clicks anywhere outside of the register modal, close it
            window.onclick = function(event) {
                if (event.target == registerModal) {
                    registerModal.style.display = 'none';
                }
                else if (event.target == loginModal) {
                    loginModal.style.display = 'none';
                }
                else if (event.target.className === "modal") {
                    $(event.target).hide();
                }
            }

            // Get the login modal
            var verificationModal = document.getElementById('verification-modal');

            // Get the <span> element that closes the login modal
            var verificationClose = document.getElementById('verification_close');

            // When the user clicks on <span> (x), close the register modal
            verificationClose.onclick = function() {
                verificationModal.style.display = 'none';
            }

            function authUser(email, otp, modalType) {
                // Show spinner
                $(`#${modalType}-spinner`).show();

                // Define a timeout duration
                var timeoutDuration = 10000;

                // Set up a timer for the timeout
                var timeout = setTimeout(function() {
                    // Hide spinner
                    $(`#${modalType}-spinner`).hide();
                    // Show timeout error message
                    $(`#${modalType}-error`).text('Verify timed out. If this persists, please email support@bettr.casino.').show();
                }, timeoutDuration);

                var createUser = modalType === "register" ? true : false;

                // Make the HTTP POST request
                $.ajax({
                    url: 'https://gateway.snapser.com/xbeovm9i/v1/auth/login/email',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ "email": email, 'otp': otp, 'create_user': createUser }),
                    success: function(response) {
                        // Clear the timeout
                        clearTimeout(timeout);
                        // Hide spinner and error message
                        $(`#verification-spinner`).hide();
                        $(`#verification-error`).hide();
                        // Store the user id and session token in local storage
                        var user = response.user;
                        var userId = user.id;
                        var sessionToken = user.session_token;
                        var isBanned = user.is_banned;
                        var isVerified = user.is_verified;
                        if (isBanned) {
                            $(`#verification-error`).text('Your account is currently banned. If this persists, email support@bettr.casino.');
                        } else if (!isVerified) {
                            $(`#verification-error`).text('Your account is currently not verified using the email verification code. If this persists, email support@bettr.casino.');
                        } else {
                            $(`#verification-error`).hide();
                            $(`#verification-modal`).hide();
                            localStorage.setItem(`${prefix}user_id`, userId);
                            localStorage.setItem(`${prefix}session_token`, sessionToken);
                            $('#register-btn').hide();
                            $('#login-btn').hide();
                            $('#logout-btn').show();
                        }
                    },
                    error: function(xhr, status, error) {
                        // Clear the timeout
                        clearTimeout(timeout);
                        // Hide spinner and show error message
                        $(`#verification-spinner`).hide();
                        $(`#verification-error`).text(`Verify error. If this persists, email support@bettr.casino.`).show();
                    }
                });
            }

            // Function to show the verification modal
            function showVerificationModal(email, modalType) {

                // Get the register modal
                var parentModal = $(`#${modalType}-modal`);
                parentModal.hide();

                $('#verification-modal').show();

                var modal = document.getElementById('verification-modal');
                var modalHeader = $("#verification-modal .verification-modal-content h2");
                var modalBackButton = $("#verification_back");
                modalHeader.text(modalType === "register" ? "Register" : "Login");

                // Set the event handler for the back button
                modalBackButton.on("click", function() {
                    $('#verification-modal').hide();
                    $("#" + modalType + "-modal").show();
                });

                // Get the button that opens the login or register modal
                var btn = document.getElementById(`${modalType}-btn`);
                var rect = btn.getBoundingClientRect();

                // Calculate the modal position
                var topPosition = rect.top + window.scrollY;
                var rightPosition = 20;

                // Adjust modal position and display it
                modal.style.display = 'block';
                modal.style.top = `${topPosition}px`;
                modal.style.right = `${rightPosition}px`;

                $('#verification_button').click(function() {
                    var otp = $("#verification-form input[name='verification_code']").val();
                    authUser(email, otp, modalType);
                });

            }

            function generateVerificationCode(modalType) {
                var email = $(`#${modalType}-modal input[name='email']`).val();
                // Show spinner
                $(`#${modalType}-spinner`).show();

                // Define a timeout duration
                var timeoutDuration = 10000;

                // Set up a timer for the timeout
                var timeout = setTimeout(function() {
                    // Hide spinner
                    $(`#${modalType}-spinner`).hide();
                    // Show timeout error message
                    $(`#${modalType}-error`).text('Verification code request timed out. If this persists, email support@bettr.casino.').show();
                }, timeoutDuration);

                // Make the HTTP POST request
                $.ajax({
                    url: 'https://gateway.snapser.com/xbeovm9i/v1/auth/otp',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ "email": email }),
                    success: function(response) {
                        // Clear the timeout
                        clearTimeout(timeout);
                        // Hide spinner and error message
                        $(`#${modalType}-spinner`).hide();
                        $(`#${modalType}-error`).hide();
                        // Call showVerificationModal on success
                        showVerificationModal(email, modalType);
                    },
                    error: function(xhr, status, error) {
                        // Clear the timeout
                        clearTimeout(timeout);
                        // Hide spinner and show error message
                        $(`#${modalType}-spinner`).hide();
                        $(`#${modalType}-error').text('Verification code request error. If this persists, email support@bettr.casino.`).show();
                    }
                });
            }

            // Function to validate the session token
            function refreshSessionToken() {
                var userId = localStorage.getItem(`${prefix}user_id`);
                var sessionToken = localStorage.getItem(`${prefix}session_token`);

                if (!sessionToken)
                {
                    $('#login-btn').show();
                    $('#logout-btn').hide();
                    return;
                }

                if (userId && sessionToken) {
                    $.ajax({
                        url: 'https://gateway.snapser.com/xbeovm9i/v1/auth/refresh',
                        type: 'PATCH',
                        contentType: 'application/json',
                        headers: { 'Token': sessionToken },
                        data: JSON.stringify({ "session_token": sessionToken }),
                        success: function(response) {
                            console.log(response);

                            if (response.is_banned) {
                                // Clear local storage and show error if not verified or banned
                                localStorage.removeItem('session_token');
                                $('#login-btn').show();
                                $('#logout-btn').hide();
                                showModal('Your account has an issue. If this persists, email support@bettr.casino.');
                                return;
                            }

                            var user = response.user;

                            if (user.id !== userId) {
                                // Clear local storage if user ID doesn't match
                                localStorage.removeItem('session_token');
                                $('#login-btn').show();
                                $('#logout-btn').hide();
                                showModal('Your will need to relogin. If this persists, email support@bettr.casino.');
                                return;
                            }

                            if (!user.session_token) {
                                // Clear local storage if user ID doesn't match
                                localStorage.removeItem('session_token');
                                $('#login-btn').show();
                                $('#logout-btn').hide();
                                showModal('Your will need to relogin. If this persists, email support@bettr.casino.');
                                return;
                            }

                            // Update local storage with new session token and hide buttons
                            localStorage.setItem(`${prefix}session_token`, user.session_token);
                            $('#login-btn').hide();
                            $('#logout-btn').show();
                        },
                        error: function(xhr, status, error) {
                            // Handle error (optional)
                            console.error(error);
                            localStorage.removeItem('session_token');
                            $('#login-btn').show();
                            $('#logout-btn').hide();
                        }
                    });
                }
            }

            function initializeDeveloperAccount(user_id, session_token, task_id) {
                $('#launch-challenge-spinner').show();
                $('.status-text').text('Configuring challenge ...').show();
                $.ajax({
                    url: 'https://zgtla52nt3w5vyh6jhh6e4js6y0qbgji.lambda-url.us-west-2.on.aws/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        "user_id": user_id,
                        "session_token": session_token,
                        "task_id": task_id
                    }),
                    success: function(response) {
                        if (response.statusCode === 200) {
                            var hash_key = response.hash_key;
                            localStorage.setItem(`${prefix}hash_key`, hash_key);
                            $('.status-text').text('Configure complete.').show();
                            $('#launch-challenge-spinner').hide();
                        } else {
                            console.error("Error in Lambda response:", response);
                            $('.status-text').text('Configure failed.').show();
                            $('#launch-challenge-spinner').hide();
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Error in invoking Lambda:", error);
                        $('.status-text').text('Configure failed.').show();
                        $('#launch-challenge-spinner').hide();
                    }
                });
            }

            // Bind the showVerificationModal to the click event of the button
            $('#register_button').click(function() {
                generateVerificationCode("register");

            });

            $('#login_button').click(function() {
                generateVerificationCode("login");
            });

            // Event handlers for closing the modals
            $(".close-btn").click(function() {
                $(this).closest(".modal").hide();
            });

            // Logout button click event
            $('#logout-btn').click(function() {
                // Clear local storage
                localStorage.removeItem('session_token');

                // Hide Logout button and show Register and Login buttons
                $('#logout-btn').hide();
                $('#login-btn').show();

                var userId = localStorage.getItem(`${prefix}user_id`);
                $('#register-btn').toggle(!!userId);
            });

            // Call the validateSessionToken function
            refreshSessionToken();        
            
        });
    </script>
    

    <footer>
        <p>&copy; 2024 Bettr Casino</p>
    </footer>

</body>
</html>
